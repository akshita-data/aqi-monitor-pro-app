<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drone Air Quality Monitoring Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 24px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }
        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 16px;
        }
        .aqi-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            text-align: center;
            min-height: 120px;
        }
        .aqi-value {
            font-size: 3rem;
            font-weight: 800;
            line-height: 1;
        }
        .aqi-category {
            font-size: 1.25rem;
            margin-top: 5px;
        }
        .aqi-good { background-color: #4CAF50; } /* Green */
        .aqi-satisfactory { background-color: #5cb85c; } /* A different shade of green/light green */
        .aqi-moderate { background-color: #FFC107; } /* Yellow */
        .aqi-poor { background-color: #f0ad4e; } /* Orange-yellow */
        .aqi-very-poor { background-color: #d9534f; } /* Red */
        .aqi-severe { background-color: #5a6268; } /* Dark Grey */

        .section-heading {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c3e50;
            margin-top: 30px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        .plot-img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #e2e8f0;
            font-weight: 600;
            color: #4a5568;
        }
        tr:nth-child(even) {
            background-color: #f8fafd;
        }
        tr:hover {
            background-color: #f0f4f7;
        }
        .status-message {
            padding: 15px;
            background-color: #e0f2fe;
            border-left: 5px solid #2196F3;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            color: #0d47a1;
        }
        .map-placeholder {
            background-color: #e9e9e9;
            min-height: 300px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-style: italic;
            color: #666;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 lg:p-8">
    <div class="container">
        <h1 class="text-4xl font-extrabold text-center text-blue-800 mb-8">
            <span class="inline-block align-middle mr-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8.786 3.197a1.077 1.077 0 0 0 -1.572 0l-3.5 4.072L.037 11.026a.456.456 0 0 0 .614.636l4.05-2.025 3.196-4.227ZM11 5.511l2.928 3.407a.456.456 0 0 0 .614-.636L11.701 4.7l-.37-.478-1.554 2.126-1.472-1.61zM9.5 11l-3.268 3.568a.456.456 0 0 0 .653.63l.942-.472 2.535-3.082L9.5 11zM10.74 15.659a.456.456 0 0 0 .653-.63l.942-.472 2.535-3.082 1.458 1.6-1.581 2.03-3.997 2.554z"/>
                    <path d="M15.5 10a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5z"/>
                    <path d="M.5 10a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1H1a.5.5 0 0 1-.5-.5z"/>
                    <path d="M10 15.5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5z"/>
                    <path d="M10.16 6.136a.5.5 0 0 0-.653-.63L7.75 6.944 6.177 4.793a.5.5 0 0 0-.825.437l1.547 2.113-1.677 2.17a.5.5 0 0 0 .825.437l1.677-2.17 1.572 2.03a.5.5 0 0 0 .653-.63l-.71-1.22z"/>
                </svg>
            </span>
            Smart Drone AQI Monitoring
        </h1>

        <p class="status-message">
            This dashboard showcases a conceptual solution for real-time air quality monitoring using drones.
            It addresses the limitations of fixed stations by providing mobile, spatially-aware pollution data.
            The data shown below is simulated for demonstration purposes.
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <div class="card col-span-1 md:col-span-2 lg:col-span-1">
                <h2 class="card-title">Current Overall AQI</h2>
                <div id="currentAqiDisplay" class="aqi-indicator aqi-good">
                    <div class="aqi-value">Loading...</div>
                    <div class="aqi-category">Fetching Data</div>
                </div>
                <p class="mt-4 text-sm text-gray-600">
                    This reflects the most recent simulated AQI reading from our drone fleet. Data is regenerated upon each page load or API call.
                </p>
            </div>

            <div class="card col-span-1 md:col-span-1">
                <h2 class="card-title">Pollutant Breakdown (Latest)</h2>
                <div id="pollutantBreakdown">
                    <p>Loading pollutant data...</p>
                </div>
            </div>

            <div class="card col-span-1 md:col-span-1">
                <h2 class="card-title">Real-time Pollution Hotspot Map</h2>
                <div id="pollutionMap" class="map-placeholder">
                    <p>Interactive Map coming soon!<br> (Requires a mapping library like Leaflet/OpenLayers)</p>
                </div>
                <p class="mt-4 text-sm text-gray-600">
                    Visualize where pollution levels are highest. This map will show data points from drone paths.
                </p>
            </div>
        </div>

        <h2 class="section-heading">AQI Trends and Analysis</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card">
                <h2 class="card-title">Overall AQI Trend Over Time</h2>
                <img id="aqiTrendPlot" src="/plots/aqi_trend.png" alt="Overall AQI Trend" class="plot-img" onerror="this.onerror=null;this.src='https://placehold.co/600x400/CCCCCC/333333?text=AQI+Trend+Plot';" />
                <p class="text-sm text-gray-600">
                    This chart illustrates the fluctuations in overall AQI based on drone measurements over time.
                </p>
            </div>
            <div class="card">
                <h2 class="card-title">PM2.5 Distribution</h2>
                <img id="pm25DistributionPlot" src="/plots/pm25_distribution.png" alt="PM2.5 Distribution" class="plot-img" onerror="this.onerror=null;this.src='https://placehold.co/600x400/CCCCCC/333333?text=PM2.5+Distribution+Plot';" />
                <p class="text-sm text-gray-600">
                    Understand the common ranges of PM2.5 concentrations detected.
                </p>
            </div>
            <div class="card">
                <h2 class="card-title">PM2.5 vs Temperature (AQI Category)</h2>
                <img id="pm25TempScatterPlot" src="/plots/pm25_temp_scatter.png" alt="PM2.5 vs Temperature" class="plot-img" onerror="this.onerror=null;this.src='https://placehold.co/600x400/CCCCCC/333333?text=PM2.5+vs+Temp+Plot';" />
                <p class="text-sm text-gray-600">
                    Explore potential correlations between temperature and PM2.5 levels, categorized by overall AQI.
                </p>
            </div>
            <div class="card">
                <h2 class="card-title">Correlation Matrix of Parameters</h2>
                <img id="correlationHeatmapPlot" src="/plots/correlation_heatmap.png" alt="Correlation Heatmap" class="plot-img" onerror="this.onerror=null;this.src='https://placehold.co/600x400/CCCCCC/333333?text=Correlation+Heatmap+Plot';" />
                <p class="text-sm text-gray-600">
                    A heatmap showing how different pollution parameters and the overall AQI relate to each other.
                </p>
            </div>
        </div>

        <h2 class="section-heading">Machine Learning Insights</h2>
        <div class="card">
            <h2 class="card-title">Predicted Air Quality (PM2.5)</h2>
            <div id="mlPredictionOutput" class="p-4 bg-blue-50 border-l-4 border-blue-200 rounded-md text-blue-800">
                <p>Loading ML prediction results...</p>
            </div>
            <p class="mt-4 text-sm text-gray-600">
                Our machine learning model aims to predict future pollutant levels or identify patterns.
                For this hackathon, we used a Random Forest Regressor to predict PM2.5 based on other factors.
            </p>
        </div>

        <h2 class="section-heading">Raw Data Sample</h2>
        <div class="card overflow-x-auto">
            <h2 class="card-title">Latest Drone Readings Sample</h2>
            <div id="dataTable" class="min-w-full">
                <p>Loading latest data sample...</p>
            </div>
            <p class="mt-4 text-sm text-gray-600">
                A snapshot of the raw data collected by the simulated drones.
            </p>
        </div>
    </div>

    <script>
        // Function to fetch data from Flask API and populate dashboard
        async function loadAQIData() {
            try {
                const response = await fetch('/api/latest_aqi_data');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                const latestRecord = data.latest_aqi;
                const tableData = data.table_data;
                const mlMetrics = data.ml_metrics;

                // --- Update Current Overall AQI ---
                const aqiDisplay = document.getElementById('currentAqiDisplay');
                if (latestRecord && latestRecord.Overall_AQI !== undefined) {
                    aqiDisplay.querySelector('.aqi-value').textContent = latestRecord.Overall_AQI;
                    aqiDisplay.querySelector('.aqi-category').textContent = latestRecord.AQI_Category;

                    // Remove existing category classes and add the new one
                    aqiDisplay.className = 'aqi-indicator'; // Reset classes
                    const aqiCategory = latestRecord.AQI_Category;
                    if (aqiCategory === 'Good') aqiDisplay.classList.add('aqi-good');
                    else if (aqiCategory === 'Satisfactory') aqiDisplay.classList.add('aqi-satisfactory');
                    else if (aqiCategory === 'Moderate') aqiDisplay.classList.add('aqi-moderate');
                    else if (aqiCategory === 'Poor') aqiDisplay.classList.add('aqi-poor');
                    else if (aqiCategory === 'Very Poor') aqiDisplay.classList.add('aqi-very-poor');
                    else if (aqiCategory === 'Severe') aqiDisplay.classList.add('aqi-severe');
                    else aqiDisplay.classList.add('aqi-good'); // Default in case of unknown category
                } else {
                    aqiDisplay.querySelector('.aqi-value').textContent = 'N/A';
                    aqiDisplay.querySelector('.aqi-category').textContent = 'Data Missing';
                    aqiDisplay.classList.add('aqi-severe'); // Indicate an issue
                }

                // --- Populate Pollutant Breakdown ---
                const pollutantBreakdown = document.getElementById('pollutantBreakdown');
                if (latestRecord) {
                    pollutantBreakdown.innerHTML = `
                        <p><strong>PM2.5:</strong> ${parseFloat(latestRecord['PM2.5']).toFixed(2)} µg/m³</p>
                        <p><strong>PM10:</strong> ${parseFloat(latestRecord.PM10).toFixed(2)} µg/m³</p>
                        <p><strong>CO:</strong> ${parseFloat(latestRecord.CO).toFixed(2)} ppm</p>
                        <p><strong>NO2:</strong> ${parseFloat(latestRecord.NO2).toFixed(2)} ppb</p>
                        <p><strong>SO2:</strong> ${parseFloat(latestRecord.SO2).toFixed(2)} ppb</p>
                        <p><strong>O3:</strong> ${parseFloat(latestRecord.O3).toFixed(2)} ppb</p>
                    `;
                } else {
                    pollutantBreakdown.innerHTML = '<p>No latest pollutant data available.</p>';
                }

                // --- Update ML Prediction Output ---
                const mlOutputDiv = document.getElementById('mlPredictionOutput');
                if (mlMetrics && mlMetrics.message) {
                    mlOutputDiv.innerHTML = `
                        <p><strong>Simulated ML Insight:</strong> ${mlMetrics.message}</p>
                        <p class="text-sm mt-2 text-gray-500">
                            <strong>Model Performance:</strong><br>
                            Mean Squared Error: ${mlMetrics.mse !== null ? mlMetrics.mse.toFixed(2) : 'N/A'}<br>
                            R-squared: ${mlMetrics.r2 !== null ? mlMetrics.r2.toFixed(2) : 'N/A'}
                        </p>
                    `;
                } else {
                    mlOutputDiv.innerHTML = '<p>No ML prediction insights available.</p>';
                }

                // --- Populate Data Table ---
                const dataTable = document.getElementById('dataTable');
                if (tableData && tableData.length > 0) {
                    // Extract headers from the first object
                    const headers = Object.keys(tableData[0]);

                    let tableHTML = '<table><thead><tr>';
                    headers.forEach(header => {
                        tableHTML += `<th>${header}</th>`;
                    });
                    tableHTML += '</tr></thead><tbody>';

                    tableData.forEach(row => {
                        tableHTML += '<tr>';
                        headers.forEach(header => {
                            let cellValue = row[header];
                            // Format timestamp for display
                            if (header === 'timestamp' && cellValue) {
                                cellValue = new Date(cellValue * 1000).toLocaleString();
                            } else if (typeof cellValue === 'number') {
                                cellValue = cellValue.toFixed(2);
                            }
                            tableHTML += `<td>${cellValue}</td>`;
                        });
                        tableHTML += '</tr>';
                    });
                    tableHTML += '</tbody></table>';
                    dataTable.innerHTML = tableHTML;
                } else {
                    dataTable.innerHTML = '<p>No raw data sample available.</p>';
                }

                // --- Refresh Plots ---
                // Force reload of images by appending a timestamp query parameter
                document.getElementById('aqiTrendPlot').src = `/plots/aqi_trend.png?t=${new Date().getTime()}`;
                document.getElementById('pm25DistributionPlot').src = `/plots/pm25_distribution.png?t=${new Date().getTime()}`;
                document.getElementById('pm25TempScatterPlot').src = `/plots/pm25_temp_scatter.png?t=${new Date().getTime()}`;
                document.getElementById('correlationHeatmapPlot').src = `/plots/correlation_heatmap.png?t=${new Date().getTime()}`;

            } catch (error) {
                console.error('Failed to load AQI data:', error);
                // Update UI to show error state
                document.getElementById('currentAqiDisplay').innerHTML = '<div class="aqi-value">Error</div><div class="aqi-category">Check server</div>';
                document.getElementById('currentAqiDisplay').className = 'aqi-indicator aqi-severe';
                document.getElementById('pollutantBreakdown').innerHTML = '<p>Error loading pollutant data.</p>';
                document.getElementById('mlPredictionOutput').innerHTML = '<p>Error loading ML insights.</p>';
                document.getElementById('dataTable').innerHTML = '<p>Could not load data table. Ensure Flask server is running.</p>';
            }
        }

        // Load data when the page loads
        window.onload = () => {
            loadAQIData();
            // Set an interval to refresh data periodically (e.g., every 30 seconds)
            setInterval(loadAQIData, 30000); // Refresh every 30 seconds
        };
    </script>
</body>
</html>